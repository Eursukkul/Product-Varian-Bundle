# üìä Stock Logic - Complete Explanation with Examples

## üìã Overview

**Stock Logic** ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏•‡πÑ‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡πà‡∏≤ Bundle (‡∏ä‡∏∏‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤) ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Å‡∏µ‡πà‡∏ä‡∏∏‡∏î ‡πÇ‡∏î‡∏¢‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏à‡∏≤‡∏Å‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏

---

## üéØ Requirement from Assignment

> **‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö:** ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏π‡∏ï‡∏£/‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏ß‡πà‡∏≤ "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î = ‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á (‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á/‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ) ‡∏ï‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô" ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 1 ‡∏ä‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå

---

## üìê Formula - ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì

### **‡∏™‡∏π‡∏ï‡∏£‡∏´‡∏•‡∏±‡∏Å (Mathematical Formula)**

```
‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Bundle ‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î = MIN(‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß / ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠ Bundle)

‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå:

MaxBundles = MIN(Q‚ÇÅ/R‚ÇÅ, Q‚ÇÇ/R‚ÇÇ, Q‚ÇÉ/R‚ÇÉ, ..., Q‚Çô/R‚Çô)

‡πÇ‡∏î‡∏¢‡∏ó‡∏µ‡πà:
- Q·µ¢ = ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà i (Available Quantity)
- R·µ¢ = ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠ 1 Bundle ‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà i (Required Quantity)
- n = ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Bundle
```

### **Algorithm (Step-by-Step)**

```
1. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô Bundle:
   a. ‡∏î‡∏∂‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ (Q·µ¢)
   b. ‡∏î‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠ Bundle (R·µ¢)
   c. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Bundle ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ = Q·µ¢ √∑ R·µ¢ (‡∏õ‡∏±‡∏î‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡∏ó‡∏¥‡πâ‡∏á)

2. ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î (MIN) ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
   ‚Üí ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Bundle ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ

3. ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö MIN = "Bottleneck" (‡∏Ñ‡∏≠‡∏Ç‡∏ß‡∏î)
   ‚Üí ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï Bundle
```

---

## üí° Example 1: Basic Calculation

### **Scenario: Gaming PC Bundle**

**Bundle Configuration:**

| ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ | ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ (R·µ¢) | ‡∏´‡∏ô‡πà‡∏ß‡∏¢ |
|--------|---------------------|-------|
| CPU | 1 | ‡∏ä‡∏¥‡πâ‡∏ô |
| RAM (16GB) | 2 | ‡πÅ‡∏ó‡πà‡∏á |
| SSD (1TB) | 1 | ‡∏ä‡∏¥‡πâ‡∏ô |
| Graphics Card | 1 | ‡∏ä‡∏¥‡πâ‡∏ô |

**Current Stock (Warehouse ID: 1):**

| ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ | ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Q·µ¢) |
|--------|------------------|
| CPU | 50 |
| RAM (16GB) | 150 |
| SSD (1TB) | 30 |
| Graphics Card | 100 |

### **Calculation:**

```
1. CPU:           50 √∑ 1 = 50 bundles
2. RAM:          150 √∑ 2 = 75 bundles
3. SSD:           30 √∑ 1 = 30 bundles  ‚ö†Ô∏è BOTTLENECK
4. Graphics Card: 100 √∑ 1 = 100 bundles

MaxBundles = MIN(50, 75, 30, 100) = 30 bundles
```

### **Result:**

- ‚úÖ **‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: 30 Bundle**
- ‚ö†Ô∏è **Bottleneck: SSD (1TB)** - ‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 30 ‡∏ä‡∏¥‡πâ‡∏ô ‡∏à‡∏∂‡∏á‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà 30 Bundle
- üí° **‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡πÅ‡∏°‡πâ‡∏ß‡πà‡∏≤ CPU ‡∏à‡∏∞‡∏°‡∏µ 50 ‡∏ä‡∏¥‡πâ‡∏ô ‡πÅ‡∏•‡∏∞ Graphics Card ‡∏°‡∏µ 100 ‡∏ä‡∏¥‡πâ‡∏ô ‡πÅ‡∏ï‡πà SSD ‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 30 ‡∏ä‡∏¥‡πâ‡∏ô ‡∏à‡∏∂‡∏á‡∏ó‡∏≥ Bundle ‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 30 ‡∏ä‡∏∏‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô

### **JSON Response Example:**

```json
{
  "success": true,
  "message": "Bundle can produce 30 units",
  "data": {
    "bundleId": 1,
    "bundleName": "Gaming PC Bundle",
    "warehouseId": 1,
    "warehouseName": "Warehouse Bangkok",
    "maxAvailableBundles": 30,
    "itemsStockBreakdown": [
      {
        "itemName": "CPU",
        "itemSku": "CPU-INTEL-I9",
        "requiredQuantity": 1,
        "availableQuantity": 50,
        "possibleBundles": 50,
        "isBottleneck": false
      },
      {
        "itemName": "RAM (16GB)",
        "itemSku": "RAM-16GB-DDR4",
        "requiredQuantity": 2,
        "availableQuantity": 150,
        "possibleBundles": 75,
        "isBottleneck": false
      },
      {
        "itemName": "SSD (1TB)",
        "itemSku": "SSD-1TB-NVME",
        "requiredQuantity": 1,
        "availableQuantity": 30,
        "possibleBundles": 30,
        "isBottleneck": true   // ‚ö†Ô∏è This limits production
      },
      {
        "itemName": "Graphics Card",
        "itemSku": "GPU-RTX-4090",
        "requiredQuantity": 1,
        "availableQuantity": 100,
        "possibleBundles": 100,
        "isBottleneck": false
      }
    ],
    "explanation": "Bundle availability limited by SSD (1TB) - only 30 units available"
  }
}
```

---

## üí° Example 2: T-Shirt Bundle with Different Quantities

### **Scenario: Premium Clothing Bundle**

**Bundle Configuration:**

| ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ | ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ (R·µ¢) | ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ |
|--------|---------------------|---------|
| T-Shirt (Size M, Red) | 1 | Variant ID: 101 |
| T-Shirt (Size L, Blue) | 1 | Variant ID: 102 |
| Shorts (Size M) | 2 | ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ 2 ‡∏ï‡∏±‡∏ß‡∏ï‡πà‡∏≠ Bundle |
| Cap | 1 | Product ID: 10 |

**Current Stock (Warehouse ID: 1):**

| ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ | ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Q·µ¢) |
|--------|------------------|
| T-Shirt (M, Red) | 100 |
| T-Shirt (L, Blue) | 45 |
| Shorts (M) | 120 |
| Cap | 200 |

### **Calculation:**

```
1. T-Shirt (M, Red):  100 √∑ 1 = 100 bundles
2. T-Shirt (L, Blue):  45 √∑ 1 = 45 bundles  ‚ö†Ô∏è BOTTLENECK
3. Shorts (M):        120 √∑ 2 = 60 bundles
4. Cap:               200 √∑ 1 = 200 bundles

MaxBundles = MIN(100, 45, 60, 200) = 45 bundles
```

### **Result:**

- ‚úÖ **‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: 45 Bundle**
- ‚ö†Ô∏è **Bottleneck: T-Shirt (L, Blue)** - ‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 45 ‡∏ï‡∏±‡∏ß
- üí° **‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï:** Shorts ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ 2 ‡∏ï‡∏±‡∏ß‡∏ï‡πà‡∏≠ Bundle ‡πÅ‡∏ï‡πà‡∏Å‡πá‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≠‡∏Ç‡∏ß‡∏î ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ 120 ‡∏ï‡∏±‡∏ß (‡∏ó‡∏≥‡πÑ‡∏î‡πâ 60 Bundle)

### **After Selling 10 Bundles:**

**Remaining Stock:**

| ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ | ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏Ç‡∏≤‡∏¢ | ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ | ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏¢ | Bundle ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ |
|--------|------------|------|-------------|--------------|
| T-Shirt (M, Red) | 100 | 10 | 90 | 90 |
| T-Shirt (L, Blue) | 45 | 10 | **35** | **35** ‚ö†Ô∏è |
| Shorts (M) | 120 | 20 | 100 | 50 |
| Cap | 200 | 10 | 190 | 190 |

**New MaxBundles = MIN(90, 35, 50, 190) = 35 bundles**

---

## üí° Example 3: Zero Stock Scenario

### **Scenario: Out of Stock Item**

**Bundle Configuration:**

| ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ | Required | Available | Possible Bundles |
|--------|----------|-----------|------------------|
| Item A | 1 | 50 | 50 |
| Item B | 2 | **0** | **0** ‚ö†Ô∏è |
| Item C | 1 | 100 | 100 |

### **Calculation:**

```
MaxBundles = MIN(50, 0, 100) = 0 bundles
```

### **Result:**

- ‚ùå **‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: 0 Bundle**
- ‚ö†Ô∏è **Bottleneck: Item B** - ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏°‡∏î (Out of Stock)
- üí° **‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≤‡∏¢ Bundle ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢** ‡πÅ‡∏°‡πâ‡∏ß‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡∏à‡∏∞‡∏°‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠

---

## üí° Example 4: High Required Quantity

### **Scenario: Promotional Bundle (Buy 10 Get Discount)**

**Bundle Configuration:**

| ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ | Required (R·µ¢) | Available (Q·µ¢) | Calculation |
|--------|--------------|----------------|-------------|
| Pen | 10 | 250 | 250 √∑ 10 = **25** ‚ö†Ô∏è |
| Notebook | 5 | 200 | 200 √∑ 5 = 40 |
| Eraser | 3 | 150 | 150 √∑ 3 = 50 |

### **Calculation:**

```
MaxBundles = MIN(25, 40, 50) = 25 bundles
```

### **Result:**

- ‚úÖ **‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: 25 Bundle**
- ‚ö†Ô∏è **Bottleneck: Pen** - ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ 10 ‡∏î‡πâ‡∏≤‡∏°‡∏ï‡πà‡∏≠ Bundle
- üí° **‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ 1 Bundle ‡∏à‡∏∞‡πÉ‡∏ä‡πâ:**
  - Pen: 10 ‡∏î‡πâ‡∏≤‡∏°
  - Notebook: 5 ‡πÄ‡∏•‡πà‡∏°
  - Eraser: 3 ‡∏Å‡πâ‡∏≠‡∏ô

---

## üîç Bottleneck Detection Algorithm

### **‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏ "‡∏Ñ‡∏≠‡∏Ç‡∏ß‡∏î" (Bottleneck)**

```csharp
public class StockCalculationService
{
    public BundleStockDto CalculateBundleStock(int bundleId, int warehouseId)
    {
        var bundle = GetBundleWithItems(bundleId);
        var stockBreakdown = new List<ItemStockBreakdown>();
        
        int minPossibleBundles = int.MaxValue;
        
        // Step 1: Calculate possible bundles for each item
        foreach (var item in bundle.Items)
        {
            var stock = GetStock(warehouseId, item.ItemType, item.ItemId);
            var possibleBundles = stock.Quantity / item.RequiredQuantity;
            
            stockBreakdown.Add(new ItemStockBreakdown
            {
                ItemName = GetItemName(item),
                RequiredQuantity = item.RequiredQuantity,
                AvailableQuantity = stock.Quantity,
                PossibleBundles = possibleBundles
            });
            
            // Track minimum
            if (possibleBundles < minPossibleBundles)
                minPossibleBundles = possibleBundles;
        }
        
        // Step 2: Mark bottlenecks (items with possibleBundles == min)
        foreach (var item in stockBreakdown)
        {
            item.IsBottleneck = (item.PossibleBundles == minPossibleBundles);
        }
        
        return new BundleStockDto
        {
            MaxAvailableBundles = minPossibleBundles,
            ItemsStockBreakdown = stockBreakdown
        };
    }
}
```

---

## üìä SQL Query Implementation

### **Optimized SQL for Stock Calculation**

```sql
-- Calculate maximum available bundles for a specific bundle and warehouse
WITH BundleStockCalculation AS (
    SELECT 
        bi.BundleId,
        bi.ItemType,
        bi.ItemId,
        bi.Quantity AS RequiredQuantity,
        s.Quantity AS AvailableQuantity,
        s.WarehouseId,
        FLOOR(s.Quantity / bi.Quantity) AS PossibleBundles,
        CASE 
            WHEN bi.ItemType = 'Variant' THEN pv.SKU
            WHEN bi.ItemType = 'Product' THEN pm.Name
        END AS ItemName
    FROM BundleItems bi
    INNER JOIN Stocks s 
        ON bi.ItemType = s.ItemType 
        AND bi.ItemId = s.ItemId
    LEFT JOIN ProductVariants pv 
        ON bi.ItemType = 'Variant' 
        AND bi.ItemId = pv.Id
    LEFT JOIN ProductMasters pm 
        ON bi.ItemType = 'Product' 
        AND bi.ItemId = pm.Id
    WHERE bi.BundleId = @BundleId
        AND s.WarehouseId = @WarehouseId
),
MinBundles AS (
    SELECT 
        BundleId,
        WarehouseId,
        MIN(PossibleBundles) AS MaxAvailableBundles
    FROM BundleStockCalculation
    GROUP BY BundleId, WarehouseId
)
SELECT 
    bsc.*,
    mb.MaxAvailableBundles,
    CASE 
        WHEN bsc.PossibleBundles = mb.MaxAvailableBundles 
        THEN 1 
        ELSE 0 
    END AS IsBottleneck
FROM BundleStockCalculation bsc
CROSS JOIN MinBundles mb
ORDER BY IsBottleneck DESC, bsc.ItemName;
```

---

## üß™ Test Cases

### **Test Case 1: Normal Scenario**

```csharp
[Fact]
public async Task CalculateBundleStock_WithSufficientStock_ReturnsCorrectMaxBundles()
{
    // Arrange
    var bundleId = 1;
    var warehouseId = 1;
    
    // Bundle items:
    // - Item A: requires 1, available 50 ‚Üí 50 bundles
    // - Item B: requires 2, available 80 ‚Üí 40 bundles (bottleneck)
    // - Item C: requires 1, available 100 ‚Üí 100 bundles
    
    // Act
    var result = await _service.CalculateBundleStockAsync(bundleId, warehouseId);
    
    // Assert
    Assert.Equal(40, result.MaxAvailableBundles);
    Assert.True(result.ItemsStockBreakdown
        .Single(x => x.ItemName == "Item B")
        .IsBottleneck);
}
```

### **Test Case 2: Out of Stock**

```csharp
[Fact]
public async Task CalculateBundleStock_WithZeroStock_ReturnsZeroBundles()
{
    // Arrange
    var bundleId = 2;
    var warehouseId = 1;
    
    // Bundle items:
    // - Item A: requires 1, available 50 ‚Üí 50 bundles
    // - Item B: requires 1, available 0 ‚Üí 0 bundles (bottleneck)
    
    // Act
    var result = await _service.CalculateBundleStockAsync(bundleId, warehouseId);
    
    // Assert
    Assert.Equal(0, result.MaxAvailableBundles);
}
```

---

## üéØ Summary

### **Key Points:**

1. **‡∏™‡∏π‡∏ï‡∏£‡∏´‡∏•‡∏±‡∏Å:** 
   ```
   MaxBundles = MIN(Q‚ÇÅ/R‚ÇÅ, Q‚ÇÇ/R‚ÇÇ, ..., Q‚Çô/R‚Çô)
   ```

2. **Bottleneck:** ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ `Q·µ¢/R·µ¢` ‡∏ï‡πà‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î

3. **Constraint:** ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (Same Warehouse)

4. **Algorithm:** O(n) time complexity where n = number of items in bundle

5. **Business Rule:** 
   - ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô MaxBundles
   - ‡∏ï‡πâ‡∏≠‡∏á restock bottleneck item ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢

### **Visual Formula:**

```
Bundle Stock = MIN of all (Available √∑ Required)
               ‚Üì
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ           ‚îÇ
    Item A: 50/1=50  Item B: 80/2=40  Item C: 100/1=100
                          ‚Üì
                     üéØ Bottleneck
                     (Limits to 40)
```

---

**Last Updated:** October 17, 2025  
**Status:** ‚úÖ Production Ready  
**Version:** 1.0
